<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Calibra QMS - Validação</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';</script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #071526; 
            color: #e8f4ff; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            gap: 20px; 
            height: 100vh; 
            box-sizing: border-box; 
        }
        
        /* Painel Esquerdo (Controles) */
        .sidebar { 
            background-color: #0b2a3a; 
            padding: 20px; 
            border-radius: 8px; 
            width: 350px; 
            min-width: 350px;
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.5); 
            overflow-y: auto; 
        }
        
        /* Painel Direito (Canvas do PDF) */
        .preview-area { 
            flex-grow: 1; 
            background-color: #333; 
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            overflow: auto; 
            position: relative; 
            padding: 20px; 
        }
        
        /* Estilos de Formulário */
        label { font-weight: bold; font-size: 0.9rem; color: #4ea8ff; display: block; margin-bottom: 5px; }
        .form-control { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #4ea8ff; background-color: #071526; color: white; box-sizing: border-box; }
        select.form-control { cursor: pointer; }
        
        button.btn-primary { 
            background-color: #2d6a4f; 
            color: white; 
            border: none; 
            padding: 15px; 
            border-radius: 4px; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            transition: 0.3s; 
            margin-top: 20px; 
        }
        button.btn-primary:hover { background-color: #24553f; transform: scale(1.02); }

        /* Canvas Container */
        #canvas-container { position: relative; border: 1px solid #999; box-shadow: 0 0 20px black; height: fit-content; }
        canvas { display: block; }
        
        /* Caixa de Seleção (Overlay) */
        #selection-box {
            position: absolute;
            border: 2px solid #4ea8ff;
            background-color: rgba(78, 168, 255, 0.3);
            display: none;
            pointer-events: none; /* Deixa o mouse passar para o canvas */
        }
        
        h2 { margin-top: 0; border-bottom: 1px solid #4ea8ff; padding-bottom: 10px; }
        
        /* Bloco de Erro */
        .error-box {
            background-color: #ff4444; 
            color: white; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Calibra QMS Web</h2>
        <p style="font-size: 0.8rem; color: #aaa;">Selecione os arquivos, escolha o responsável e desenhe a área do carimbo na imagem.</p>
        
        <form method="post" enctype="multipart/form-data" id="stampForm">
            {% csrf_token %}
            
            {% if form.errors %}
                <div class="error-box">
                    <strong>Corrija os erros:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}
            <div style="margin-top: 10px;">
                <label>{{ form.colaborador.label }}</label>
                {{ form.colaborador }}
            </div>
            <div style="margin-top: 10px;">
                <label>{{ form.status_validacao.label }}</label>
                {{ form.status_validacao }}
            </div>
            <div style="margin-top: 10px;">
                <label>{{ form.arquivo_pdf.label }}</label>
                {{ form.arquivo_pdf }}
            </div>

            {{ form.x }} {{ form.y }} {{ form.w }} {{ form.h }}
            {{ form.page_width }} {{ form.page_height }}

            <button type="submit" class="btn-primary">Carimbar e Baixar</button>
        </form>
        
        <div id="status-msg" style="color: yellow; font-size: 0.9rem; margin-top: 10px;"></div>
    </div>

    <div class="preview-area">
        <div id="canvas-container">
            <canvas id="pdf-render"></canvas>
            <div id="selection-box"></div>
        </div>
    </div>

    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.5; // Zoom inicial
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');
        const selectionBox = document.getElementById('selection-box');
        const container = document.getElementById('canvas-container');

        // Variáveis de Arrastar
        let isDragging = false;
        let startX, startY;

        // inputs ocultos
        const inputX = document.getElementsByName('x')[0];
        const inputY = document.getElementsByName('y')[0];
        const inputW = document.getElementsByName('w')[0];
        const inputH = document.getElementsByName('h')[0];
        const inputPW = document.getElementsByName('page_width')[0];
        const inputPH = document.getElementsByName('page_height')[0];

        // Função chamada quando o usuário escolhe arquivos
        function carregarPreview(event) {
            // Pega a lista de arquivos
            const fileList = event.target.files;
            
            if (fileList.length > 0) {
                // Pega SEMPRE o primeiro arquivo para preview
                const file = fileList[0];
                
                // Feedback visual se for lote
                const statusMsg = document.getElementById('status-msg');
                if (fileList.length > 1) {
                    statusMsg.innerText = `Lote detectado: ${fileList.length} arquivos selecionados. Use a imagem ao lado para posicionar o carimbo em TODOS eles.`;
                    statusMsg.style.color = "#4ea8ff"; // Azul
                } else {
                    statusMsg.innerText = "Desenhe a área do carimbo na imagem ->";
                    statusMsg.style.color = "yellow";
                }

                if (file.type === "application/pdf") {
                    const fileReader = new FileReader();
                    fileReader.onload = function() {
                        const typedarray = new Uint8Array(this.result);
                        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                            pdfDoc = pdf;
                            renderPage(pageNum);
                        });
                    };
                    fileReader.readAsArrayBuffer(file);
                }
            }
        }

        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // IMPORTANTE: Salva dimensões reais do canvas para enviar ao backend
                // O backend precisa saber o tamanho da tela para calcular a proporção
                if(inputPW) inputPW.value = viewport.width;
                if(inputPH) inputPH.value = viewport.height;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }

        // --- Lógica do Mouse (Arrastar para desenhar) ---
        
        container.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDragging = true;
            
            // Reseta caixa visual
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            selectionBox.style.display = 'block';
            selectionBox.style.left = startX + 'px';
            selectionBox.style.top = startY + 'px';
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            const width = currentX - startX;
            const height = currentY - startY;
            
            selectionBox.style.width = Math.abs(width) + 'px';
            selectionBox.style.height = Math.abs(height) + 'px';
            
            // Lidar com arrastar para trás (valores negativos)
            selectionBox.style.left = (width < 0 ? currentX : startX) + 'px';
            selectionBox.style.top = (height < 0 ? currentY : startY) + 'px';
        });

        container.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            // Pega valores finais CSS
            const rect = selectionBox.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            // Calcula posição relativa ao Canvas
            const x = rect.left - canvasRect.left;
            const y = rect.top - canvasRect.top;
            
            // Preenche formulário oculto com valores numéricos
            if(inputX) inputX.value = x;
            if(inputY) inputY.value = y;
            if(inputW) inputW.value = rect.width;
            if(inputH) inputH.value = rect.height;
            
            document.getElementById('status-msg').innerText = "Área definida! Pode clicar em Carimbar.";
        });

    </script>
</body>
</html>